<!DOCTYPE html>  <html> <head>   <title>Story.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="AdaptorBase.html">                 AdaptorBase.js               </a>                                           <a class="source" href="Animator.html">                 Animator.js               </a>                                           <a class="source" href="Backstage.html">                 Backstage.js               </a>                                           <a class="source" href="BasicTypes.html">                 BasicTypes.js               </a>                                           <a class="source" href="Commands.html">                 Commands.js               </a>                                           <a class="source" href="Config.html">                 Config.js               </a>                                           <a class="source" href="ConfigBrowser.html">                 ConfigBrowser.js               </a>                                           <a class="source" href="Crypto.html">                 Crypto.js               </a>                                           <a class="source" href="Dates.html">                 Dates.js               </a>                                           <a class="source" href="Dom.html">                 Dom.js               </a>                                           <a class="source" href="FileAdaptor.html">                 FileAdaptor.js               </a>                                           <a class="source" href="FileSystem.html">                 FileSystem.js               </a>                                           <a class="source" href="FileSystemUtils.html">                 FileSystemUtils.js               </a>                                           <a class="source" href="Filters.html">                 Filters.js               </a>                                           <a class="source" href="Formatter.html">                 Formatter.js               </a>                                           <a class="source" href="FormatterHelpers.html">                 FormatterHelpers.js               </a>                                           <a class="source" href="Guide.html">                 Guide.js               </a>                                           <a class="source" href="Http.html">                 Http.js               </a>                                           <a class="source" href="Import.html">                 Import.js               </a>                                           <a class="source" href="Lingo.html">                 Lingo.js               </a>                                           <a class="source" href="ListView.html">                 ListView.js               </a>                                           <a class="source" href="LoaderSaver.html">                 LoaderSaver.js               </a>                                           <a class="source" href="Macros.html">                 Macros.js               </a>                                           <a class="source" href="Manager.html">                 Manager.js               </a>                                           <a class="source" href="Messages.html">                 Messages.js               </a>                                           <a class="source" href="Morpher.html">                 Morpher.js               </a>                                           <a class="source" href="NewTiddler.html">                 NewTiddler.js               </a>                                           <a class="source" href="Numbers.html">                 Numbers.js               </a>                                           <a class="source" href="Options.html">                 Options.js               </a>                                           <a class="source" href="Paramifiers.html">                 Paramifiers.js               </a>                                           <a class="source" href="Popup.html">                 Popup.js               </a>                                           <a class="source" href="RGB.html">                 RGB.js               </a>                                           <a class="source" href="Refresh.html">                 Refresh.js               </a>                                           <a class="source" href="Saving.html">                 Saving.js               </a>                                           <a class="source" href="SavingRSS.html">                 SavingRSS.js               </a>                                           <a class="source" href="Scroller.html">                 Scroller.js               </a>                                           <a class="source" href="Search.html">                 Search.js               </a>                                           <a class="source" href="Slider.html">                 Slider.js               </a>                                           <a class="source" href="Sparkline.html">                 Sparkline.js               </a>                                           <a class="source" href="Story.html">                 Story.js               </a>                                           <a class="source" href="Strings.html">                 Strings.js               </a>                                           <a class="source" href="TW21Loader.html">                 TW21Loader.js               </a>                                           <a class="source" href="TW21Saver.html">                 TW21Saver.js               </a>                                           <a class="source" href="Tabs.html">                 Tabs.js               </a>                                           <a class="source" href="Tiddler.html">                 Tiddler.js               </a>                                           <a class="source" href="TiddlerFields.html">                 TiddlerFields.js               </a>                                           <a class="source" href="TiddlyWiki.html">                 TiddlyWiki.js               </a>                                           <a class="source" href="Toolbar.html">                 Toolbar.js               </a>                                           <a class="source" href="Upgrade.html">                 Upgrade.js               </a>                                           <a class="source" href="Utilities.html">                 Utilities.js               </a>                                           <a class="source" href="UtilitiesPopup.html">                 UtilitiesPopup.js               </a>                                           <a class="source" href="Version.html">                 Version.js               </a>                                           <a class="source" href="Wikifier.html">                 Wikifier.js               </a>                                           <a class="source" href="Wizard.html">                 Wizard.js               </a>                                           <a class="source" href="Zoomer.html">                 Zoomer.js               </a>                                           <a class="source" href="main.html">                 main.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Story.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>--</p>

<h2>-- Story functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>A story is a HTML div containing a sequence of tiddlers that can be manipulated</h1>

<h1>container - id of containing element</h1>

<h1>idPrefix - string prefix prepended to title to make ids for tiddlers in this story</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Story</span><span class="p">(</span><span class="nx">containerId</span><span class="p">,</span><span class="nx">idPrefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="nx">containerId</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">idPrefix</span> <span class="o">=</span> <span class="nx">idPrefix</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">highlightRegExp</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>generate tiddler ID</h1>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">tiddlerId</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h1>replace spaces in titles to ensure valid element IDs</h1>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/g</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ /g</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">idPrefix</span> <span class="o">+</span> <span class="nx">title</span><span class="p">;</span>
		<span class="k">return</span> <span class="nx">id</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">idPrefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">title</span> <span class="o">:</span> <span class="nx">id</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">containerId</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>retrieve tiddler element</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tiddlerId</span><span class="p">(</span><span class="nx">title</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getContainer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">containerId</span><span class="p">());</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h1>Iterate through all the tiddlers currently opened in a story</h1>

<h1>fn - callback function to be called for each tiddler. Arguments are:</h1>

<h1>tiddlerTitle - title of the tiddler</h1>

<h1>element - reference to tiddler display element</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forEachTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">place</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContainer</span><span class="p">();</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">place</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">place</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;tiddler&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">title</span><span class="p">,</span><span class="nx">e</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nx">e</span> <span class="o">=</span> <span class="nx">n</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">displayDefaultTiddlers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">displayTiddlers</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">store</span><span class="p">.</span><span class="nx">filterTiddlers</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getTiddlerText</span><span class="p">(</span><span class="s2">&quot;DefaultTiddlers&quot;</span><span class="p">)));</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h1>Display several tiddlers given their titles in an array. Parameters same as displayTiddler(), except:</h1>

<h1>titles - array of tiddlers or string titles</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">displayTiddlers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srcElement</span><span class="p">,</span><span class="nx">titles</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="nx">animate</span><span class="p">,</span><span class="nx">unused</span><span class="p">,</span><span class="nx">customFields</span><span class="p">,</span><span class="nx">toggle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">t</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">titles</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="nx">t</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="nx">t</span><span class="o">--</span><span class="p">)</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">displayTiddler</span><span class="p">(</span><span class="nx">srcElement</span><span class="p">,</span><span class="nx">titles</span><span class="p">[</span><span class="nx">t</span><span class="p">],</span><span class="nx">template</span><span class="p">,</span><span class="nx">animate</span><span class="p">,</span><span class="nx">unused</span><span class="p">,</span><span class="nx">customFields</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h1>Display a given tiddler with a given template. If the tiddler is already displayed but with a different</h1>

<h1>template, it is switched to the specified template. If the tiddler does not exist, and if server hosting</h1>

<h1>custom fields were provided, then an attempt is made to retrieve the tiddler from the server</h1>

<h1>srcElement - reference to element from which this one is being opened -or-</h1>

<h1>special positions "top", "bottom"</h1>

<h1>tiddler - tiddler or title of tiddler to display</h1>

<h1>template - the name of the tiddler containing the template -or-</h1>

<h1>one of the constants DEFAULT<em>VIEW</em>TEMPLATE and DEFAULT<em>EDIT</em>TEMPLATE -or-</h1>

<h1>null or undefined to indicate the current template if there is one, DEFAULT<em>VIEW</em>TEMPLATE if not</h1>

<h1>animate - whether to perform animations</h1>

<h1>customFields - an optional list of name:"value" pairs to be assigned as tiddler fields (for edit templates)</h1>

<h1>toggle - if true, causes the tiddler to be closed if it is already opened</h1>

<h1>animationSrc - optional. If provided, this will specify the element which is to act as the start of the animation -or-</h1>

<h1>the source of the animation will be the srcElement.</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">displayTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srcElement</span><span class="p">,</span><span class="nx">tiddler</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="nx">animate</span><span class="p">,</span><span class="nx">unused</span><span class="p">,</span><span class="nx">customFields</span><span class="p">,</span><span class="nx">toggle</span><span class="p">,</span><span class="nx">animationSrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tiddler</span> <span class="k">instanceof</span> <span class="nx">Tiddler</span><span class="p">)</span> <span class="o">?</span> <span class="nx">tiddler</span><span class="p">.</span><span class="nx">title</span> <span class="o">:</span> <span class="nx">tiddler</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">toggle</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">closeTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">refreshTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="nx">customFields</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">place</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContainer</span><span class="p">();</span>
		<span class="kd">var</span> <span class="nx">before</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">positionTiddler</span><span class="p">(</span><span class="nx">srcElement</span><span class="p">);</span>
		<span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createTiddler</span><span class="p">(</span><span class="nx">place</span><span class="p">,</span><span class="nx">before</span><span class="p">,</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="nx">customFields</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">animationSrc</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">animationSrc</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">srcElement</span> <span class="o">=</span> <span class="nx">animationSrc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">srcElement</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">srcElement</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">chkAnimate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">animate</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">animate</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">anim</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">Zoomer</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">Scroller</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
			<span class="nx">anim</span><span class="p">.</span><span class="nx">startAnimating</span><span class="p">(</span><span class="k">new</span> <span class="nx">Zoomer</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">srcElement</span><span class="p">,</span><span class="nx">tiddlerElem</span><span class="p">),</span><span class="k">new</span> <span class="nx">Scroller</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">scrollTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">ensureVisible</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">tiddlerElem</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h1>Figure out the appropriate position for a newly opened tiddler</h1>

<h1>srcElement - reference to the element containing the link to the tiddler -or-</h1>

<h1>special positions "top", "bottom"</h1>

<h1>returns - reference to the tiddler that the new one should appear before (null for the bottom of the story)</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">positionTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">srcElement</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">place</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContainer</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">before</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">srcElement</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="nx">srcElement</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="s2">&quot;top&quot;</span><span class="o">:</span>
			<span class="nx">before</span> <span class="o">=</span> <span class="nx">place</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="s2">&quot;bottom&quot;</span><span class="o">:</span>
			<span class="nx">before</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">after</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findContainingTiddler</span><span class="p">(</span><span class="nx">srcElement</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">after</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">before</span> <span class="o">=</span> <span class="nx">place</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">after</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">before</span> <span class="o">=</span> <span class="nx">after</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">before</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="nx">before</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">before</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h1>Create a tiddler frame at the appropriate place in a story column. If the tiddler doesn't exist,</h1>

<h1>triggers an attempt to load it as a missing tiddler</h1>

<h1>place - reference to parent element</h1>

<h1>before - null, or reference to element before which to insert new tiddler</h1>

<h1>title - title of new tiddler</h1>

<h1>template - the name of the tiddler containing the template or one of the constants DEFAULT<em>VIEW</em>TEMPLATE and DEFAULT<em>EDIT</em>TEMPLATE</h1>

<h1>customFields - an optional list of name:"value" pairs to be assigned as tiddler fields</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">place</span><span class="p">,</span><span class="nx">before</span><span class="p">,</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="nx">customFields</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="nx">createTiddlyElement</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="s2">&quot;div&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">tiddlerId</span><span class="p">(</span><span class="nx">title</span><span class="p">),</span><span class="s2">&quot;tiddler&quot;</span><span class="p">);</span>
	<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;refresh&quot;</span><span class="p">,</span><span class="s2">&quot;tiddler&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">customFields</span><span class="p">)</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;tiddlyFields&quot;</span><span class="p">,</span><span class="nx">customFields</span><span class="p">);</span>
	<span class="nx">place</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">,</span><span class="nx">before</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">defaultText</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">store</span><span class="p">.</span><span class="nx">tiddlerExists</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">store</span><span class="p">.</span><span class="nx">isShadowTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">))</span>
		<span class="nx">defaultText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadMissingTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">customFields</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">refreshTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="nx">customFields</span><span class="p">,</span><span class="nx">defaultText</span><span class="p">);</span>
	<span class="k">return</span> <span class="nx">tiddlerElem</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h1>Attempts to load a missing tiddler from the server specified in the custom fields</h1>

<h1>title - title of the missing tiddler</h1>

<h1>fields - string of name:"value" pairs or hashmap</h1>

<h1>callback - optional function invoked with context argument upon completion; context provides context.tiddler if successful</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadMissingTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">fields</span><span class="p">,</span><span class="nx">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">getTiddlerCallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">tiddler</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">created</span><span class="p">)</span>
				<span class="nx">t</span><span class="p">.</span><span class="nx">created</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">modified</span><span class="p">)</span>
				<span class="nx">t</span><span class="p">.</span><span class="nx">modified</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">created</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">dirty</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">isDirty</span><span class="p">();</span>
			<span class="nx">context</span><span class="p">.</span><span class="nx">tiddler</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">saveTiddler</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">modifier</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">modified</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">tags</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">fields</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">created</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">creator</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">!=</span> <span class="s2">&quot;file:&quot;</span><span class="p">)</span>
				<span class="nx">store</span><span class="p">.</span><span class="nx">setDirty</span><span class="p">(</span><span class="nx">dirty</span><span class="p">);</span>
			<span class="nx">autoSaveChanges</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">story</span><span class="p">.</span><span class="nx">refreshTiddler</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nx">context</span><span class="p">.</span><span class="nx">adaptor</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">callback</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="kd">var</span> <span class="nx">tiddler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="nx">tiddler</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">fields</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">?</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">decodeHashMap</span><span class="p">()</span> <span class="o">:</span> <span class="nx">fields</span><span class="o">||</span><span class="p">{};</span>
	<span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span><span class="nx">serverType</span><span class="o">:</span><span class="nx">tiddler</span><span class="p">.</span><span class="nx">getServerType</span><span class="p">()};</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">serverType</span><span class="p">)</span>
		<span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">tiddler</span><span class="p">.</span><span class="nx">fields</span><span class="p">[</span><span class="s1">&#39;server.host&#39;</span><span class="p">];</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">workspace</span> <span class="o">=</span> <span class="nx">tiddler</span><span class="p">.</span><span class="nx">fields</span><span class="p">[</span><span class="s1">&#39;server.workspace&#39;</span><span class="p">];</span>
	<span class="kd">var</span> <span class="nx">adaptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">config</span><span class="p">.</span><span class="nx">adaptors</span><span class="p">[</span><span class="nx">context</span><span class="p">.</span><span class="nx">serverType</span><span class="p">]();</span>
	<span class="nx">adaptor</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">context</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">getTiddlerCallback</span><span class="p">);</span>
	<span class="k">return</span> <span class="nx">config</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">loadingMissingTiddler</span><span class="p">.</span><span class="nx">format</span><span class="p">([</span><span class="nx">title</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">serverType</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="nx">context</span><span class="p">.</span><span class="nx">workspace</span><span class="p">]);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h1>Overridable for choosing the name of the template to apply for a tiddler</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">chooseTemplateForTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">template</span><span class="p">)</span>
		<span class="nx">template</span> <span class="o">=</span> <span class="nx">DEFAULT_VIEW_TEMPLATE</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">template</span> <span class="o">==</span> <span class="nx">DEFAULT_VIEW_TEMPLATE</span> <span class="o">||</span> <span class="nx">template</span> <span class="o">==</span> <span class="nx">DEFAULT_EDIT_TEMPLATE</span><span class="p">)</span>
		<span class="nx">template</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tiddlerTemplates</span><span class="p">[</span><span class="nx">template</span><span class="p">];</span>
	<span class="k">return</span> <span class="nx">template</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h1>Overridable for extracting the text of a template from a tiddler</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTemplateForTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="nx">tiddler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getRecursiveTiddlerText</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h1>Apply a template to an existing tiddler if it is not already displayed using that template</h1>

<h1>title - title of tiddler to update</h1>

<h1>template - the name of the tiddler containing the template or one of the constants DEFAULT<em>VIEW</em>TEMPLATE and DEFAULT<em>EDIT</em>TEMPLATE</h1>

<h1>force - if true, forces the refresh even if the template hasn't changed</h1>

<h1>customFields - an optional list of name/value pairs to be assigned as tiddler fields (for edit templates)</h1>

<h1>defaultText - an optional string to replace the default text for non-existent tiddlers</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">refreshTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="nx">force</span><span class="p">,</span><span class="nx">customFields</span><span class="p">,</span><span class="nx">defaultText</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">force</span><span class="p">)</span>
			<span class="k">return</span> <span class="nx">tiddlerElem</span><span class="p">;</span>
		<span class="nx">template</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">chooseTemplateForTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">currTemplate</span> <span class="o">=</span> <span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="nx">template</span> <span class="o">!=</span> <span class="nx">currTemplate</span><span class="p">)</span> <span class="o">||</span> <span class="nx">force</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">tiddler</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">tiddler</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">tiddler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tiddler</span><span class="p">();</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">isShadowTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">))</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">[];</span>
					<span class="nx">tiddler</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">store</span><span class="p">.</span><span class="nx">getTiddlerText</span><span class="p">(</span><span class="nx">title</span><span class="p">),</span><span class="nx">config</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">wikified</span><span class="p">.</span><span class="nx">shadowModifier</span><span class="p">,</span><span class="nx">version</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span><span class="nx">tags</span><span class="p">,</span><span class="nx">version</span><span class="p">.</span><span class="nx">date</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">template</span><span class="o">==</span><span class="s2">&quot;EditTemplate&quot;</span> <span class="o">?</span>
								<span class="nx">config</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">defaultText</span><span class="p">.</span><span class="nx">format</span><span class="p">([</span><span class="nx">title</span><span class="p">])</span> <span class="o">:</span>
								<span class="nx">config</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">wikified</span><span class="p">.</span><span class="nx">defaultText</span><span class="p">.</span><span class="nx">format</span><span class="p">([</span><span class="nx">title</span><span class="p">]);</span>
					<span class="nx">text</span> <span class="o">=</span> <span class="nx">defaultText</span> <span class="o">||</span> <span class="nx">text</span><span class="p">;</span>
					<span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="nx">customFields</span> <span class="o">?</span> <span class="nx">customFields</span><span class="p">.</span><span class="nx">decodeHashMap</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
					<span class="nx">tiddler</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">text</span><span class="p">,</span><span class="nx">config</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">wikified</span><span class="p">.</span><span class="nx">defaultModifier</span><span class="p">,</span><span class="nx">version</span><span class="p">.</span><span class="nx">date</span><span class="p">,[],</span><span class="nx">version</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span><span class="nx">fields</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span><span class="nx">tiddler</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">));</span>
			<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;tiddler&quot;</span><span class="p">,</span><span class="nx">title</span><span class="p">);</span>
			<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">,</span><span class="nx">template</span><span class="p">);</span>
			<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">onmouseover</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onTiddlerMouseOver</span><span class="p">;</span>
			<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">onmouseout</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onTiddlerMouseOut</span><span class="p">;</span>
			<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">ondblclick</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onTiddlerDblClick</span><span class="p">;</span>
			<span class="nx">tiddlerElem</span><span class="p">[</span><span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="o">?</span><span class="s2">&quot;onkeydown&quot;</span><span class="o">:</span><span class="s2">&quot;onkeypress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onTiddlerKeyPress</span><span class="p">;</span>
			<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTemplateForTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">template</span><span class="p">,</span><span class="nx">tiddler</span><span class="p">);</span>
			<span class="nx">applyHtmlMacros</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">,</span><span class="nx">tiddler</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getTaggedTiddlers</span><span class="p">(</span><span class="nx">title</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="nx">jQuery</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;isTag&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="nx">jQuery</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;isTag&quot;</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">tiddlerExists</span><span class="p">(</span><span class="nx">title</span><span class="p">))</span> <span class="p">{</span>
				<span class="nx">jQuery</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;shadow&quot;</span><span class="p">);</span>
				<span class="nx">jQuery</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">jQuery</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">isShadowTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;shadow&quot;</span> <span class="o">:</span> <span class="s2">&quot;missing&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">customFields</span><span class="p">)</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">addCustomFields</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">,</span><span class="nx">customFields</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">tiddlerElem</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h1>Add hidden input elements for the custom fields of a tiddler</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addCustomFields</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">place</span><span class="p">,</span><span class="nx">customFields</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="nx">customFields</span><span class="p">.</span><span class="nx">decodeHashMap</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">createTiddlyElement</span><span class="p">(</span><span class="nx">place</span><span class="p">,</span><span class="s2">&quot;div&quot;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="s2">&quot;customFields&quot;</span><span class="p">);</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">t</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="nx">t</span> <span class="k">in</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">);</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;text&quot;</span><span class="p">);</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="nx">fields</span><span class="p">[</span><span class="nx">t</span><span class="p">]);</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;edit&quot;</span><span class="p">,</span><span class="nx">t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h1>Refresh all tiddlers in the Story</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">refreshAllTiddlers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContainer</span><span class="p">().</span><span class="nx">firstChild</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">template</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">refreshTiddler</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;tiddler&quot;</span><span class="p">),</span><span class="nx">force</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">template</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h1>Default tiddler onmouseover/out event handlers</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onTiddlerMouseOver</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nx">jQuery</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onTiddlerMouseOut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nx">jQuery</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h1>Default tiddler ondblclick event handler</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onTiddlerDblClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">ev</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">resolveTarget</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;input&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;textarea&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">selection</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">empty</span><span class="p">)</span>
			<span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
		<span class="nx">config</span><span class="p">.</span><span class="nx">macros</span><span class="p">.</span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">invokeCommand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;defaultCommand&quot;</span><span class="p">,</span><span class="nx">e</span><span class="p">);</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">cancelBubble</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
		<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onTiddlerKeyPress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">ev</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
	<span class="nx">clearMessage</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">consume</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;tiddler&quot;</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">resolveTarget</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">9</span><span class="o">:</span> <span class="c1">// Tab</span>
		<span class="kd">var</span> <span class="nx">ed</span> <span class="o">=</span> <span class="nx">story</span><span class="p">.</span><span class="nx">getTiddlerField</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="s2">&quot;text&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">ed</span><span class="p">.</span><span class="nx">value</span><span class="o">==</span><span class="nx">config</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">defaultText</span><span class="p">.</span><span class="nx">format</span><span class="p">([</span><span class="nx">title</span><span class="p">]))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>moving from input field and editor still contains default text, so select it</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">ed</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
			<span class="nx">ed</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
			<span class="nx">consume</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">chkInsertTabs</span> <span class="o">&amp;&amp;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;textarea&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">replaceSelection</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">9</span><span class="p">));</span>
			<span class="nx">consume</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">isOpera</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">target</span><span class="p">.</span><span class="nx">onblur</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">onblur</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
			<span class="p">};</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span><span class="o">:</span> <span class="c1">// Ctrl-Enter</span>
	<span class="k">case</span> <span class="mi">10</span><span class="o">:</span> <span class="c1">// Ctrl-Enter on IE PC</span>
	<span class="k">case</span> <span class="mi">77</span><span class="o">:</span> <span class="c1">// Ctrl-Enter is &quot;M&quot; on some platforms</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">blurElement</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
			<span class="nx">config</span><span class="p">.</span><span class="nx">macros</span><span class="p">.</span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">invokeCommand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;defaultCommand&quot;</span><span class="p">,</span><span class="nx">e</span><span class="p">);</span>
			<span class="nx">consume</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">27</span><span class="o">:</span> <span class="c1">// Escape</span>
		<span class="nx">blurElement</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
		<span class="nx">config</span><span class="p">.</span><span class="nx">macros</span><span class="p">.</span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">invokeCommand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;cancelCommand&quot;</span><span class="p">,</span><span class="nx">e</span><span class="p">);</span>
		<span class="nx">consume</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">cancelBubble</span> <span class="o">=</span> <span class="nx">consume</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">consume</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span> <span class="c1">// Stop Propagation</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// Cancel The Event in IE</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span> <span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span> <span class="c1">// Cancel The Event in Moz</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">!</span><span class="nx">consume</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h1>Returns the specified field (input or textarea element) in a tiddler, otherwise the first edit field it finds</h1>

<h1>or null if it found no edit field at all</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getTiddlerField</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">t</span><span class="p">,</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="nx">t</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">t</span><span class="o">&lt;</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">t</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span> <span class="o">||</span> <span class="nx">c</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;textarea&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">e</span><span class="p">)</span>
					<span class="nx">e</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;edit&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nx">field</span><span class="p">)</span>
					<span class="nx">e</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h1>Focus a specified tiddler. Attempts to focus the specified field, otherwise the first edit field it finds</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">focusTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddlerField</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">field</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h1>Ensures that a specified tiddler does not have the focus</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">blurTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span> <span class="o">&amp;&amp;</span> <span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">focus</span> <span class="o">&amp;&amp;</span> <span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">blur</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h1>Adds a specified value to the edit controls (if any) of a particular</h1>

<h1>array-formatted field of a particular tiddler (eg "tags")</h1>

<h1>title - name of tiddler</h1>

<h1>tag - value of field, without any [[brackets]]</h1>

<h1>mode - +1 to add the tag, -1 to remove it, 0 to toggle it</h1>

<h1>field - name of field (eg "tags")</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTiddlerField</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">tag</span><span class="p">,</span><span class="nx">mode</span><span class="p">,</span><span class="nx">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddlerField</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">field</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">readBracketedList</span><span class="p">();</span>
	<span class="nx">tags</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span><span class="nx">mode</span><span class="p">);</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">encodeTiddlyLinkList</span><span class="p">(</span><span class="nx">tags</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h1>The same as setTiddlerField but preset to the "tags" field</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTiddlerTag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">tag</span><span class="p">,</span><span class="nx">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">setTiddlerField</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">tag</span><span class="p">,</span><span class="nx">mode</span><span class="p">,</span><span class="s2">&quot;tags&quot;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h1>Close a specified tiddler</h1>

<h1>title - name of tiddler to close</h1>

<h1>animate - whether to perform animations</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">closeTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">animate</span><span class="p">,</span><span class="nx">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">clearMessage</span><span class="p">();</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">scrubTiddler</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">chkAnimate</span> <span class="o">&amp;&amp;</span> <span class="nx">animate</span> <span class="o">&amp;&amp;</span> <span class="nx">anim</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">Slider</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
			<span class="nx">anim</span><span class="p">.</span><span class="nx">startAnimating</span><span class="p">(</span><span class="k">new</span> <span class="nx">Slider</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="s2">&quot;all&quot;</span><span class="p">));</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="nx">jQuery</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h1>Scrub IDs from a tiddler. This is so that the 'ghost' of a tiddler while it is being closed</h1>

<h1>does not interfere with things</h1>

<h1>tiddlerElem - reference to the tiddler element</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">scrubTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h1>Set the 'dirty' flag of a tiddler</h1>

<h1>title - title of tiddler to change</h1>

<h1>dirty - new boolean status of flag</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDirty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">dirty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">,</span><span class="nx">dirty</span> <span class="o">?</span> <span class="s2">&quot;true&quot;</span> <span class="o">:</span> <span class="s2">&quot;false&quot;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h1>Is a particular tiddler dirty (with unsaved changes)?</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isDirty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h1>Determine whether any open tiddler are dirty</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">areAnyDirty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">forEachTiddler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isDirty</span><span class="p">(</span><span class="nx">title</span><span class="p">))</span>
			<span class="nx">r</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="p">});</span>
	<span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h1>Close all tiddlers in the story</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">closeAllTiddlers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exclude</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nx">clearMessage</span><span class="p">();</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">forEachTiddler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="nx">title</span> <span class="o">!=</span> <span class="nx">exclude</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">closeTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="p">});</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">scrollTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">ensureVisible</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">container</span><span class="p">));</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h1>Check if there are any tiddlers in the story</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">place</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContainer</span><span class="p">();</span>
	<span class="k">return</span> <span class="nx">place</span> <span class="o">&amp;&amp;</span> <span class="nx">place</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">==</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h1>Perform a search and display the result</h1>

<h1>text - text to search for</h1>

<h1>useCaseSensitive - true for case sensitive matching</h1>

<h1>useRegExp - true to interpret text as a RegExp</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">search</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="nx">useCaseSensitive</span><span class="p">,</span><span class="nx">useRegExp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">closeAllTiddlers</span><span class="p">();</span>
	<span class="nx">highlightHack</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">useRegExp</span> <span class="o">?</span> <span class="nx">text</span> <span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">escapeRegExp</span><span class="p">(),</span><span class="nx">useCaseSensitive</span> <span class="o">?</span> <span class="s2">&quot;mg&quot;</span> <span class="o">:</span> <span class="s2">&quot;img&quot;</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">highlightHack</span><span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="s2">&quot;excludeSearch&quot;</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">displayTiddlers</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">matches</span><span class="p">);</span>
	<span class="nx">highlightHack</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">useRegExp</span> <span class="o">?</span> <span class="s2">&quot;/&quot;</span> <span class="o">:</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">matches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="nx">displayMessage</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">macros</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">successMsg</span><span class="p">.</span><span class="nx">format</span><span class="p">([</span><span class="nx">matches</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span><span class="nx">q</span> <span class="o">+</span> <span class="nx">text</span> <span class="o">+</span> <span class="nx">q</span><span class="p">]));</span>
	<span class="k">else</span>
		<span class="nx">displayMessage</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">macros</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">failureMsg</span><span class="p">.</span><span class="nx">format</span><span class="p">([</span><span class="nx">q</span> <span class="o">+</span> <span class="nx">text</span> <span class="o">+</span> <span class="nx">q</span><span class="p">]));</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h1>Determine if the specified element is within a tiddler in this story</h1>

<h1>e - reference to an element</h1>

<h1>returns: reference to a tiddler element or null if none</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">findContainingTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span><span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;tiddler&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="nx">e</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;popup&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">Popup</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="nx">Popup</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">root</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h1>Gather any saveable fields from a tiddler element</h1>

<h1>e - reference to an element to scan recursively</h1>

<h1>fields - object to contain gathered field values</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gatherSaveFields</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">fields</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;edit&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
			<span class="nx">fields</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r/mg</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">hasChildNodes</span><span class="p">())</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">t</span><span class="p">,</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="nx">t</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">t</span><span class="o">&lt;</span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">t</span><span class="o">++</span><span class="p">)</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">gatherSaveFields</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="nx">t</span><span class="p">],</span><span class="nx">fields</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h1>Determine whether a tiddler has any edit fields, and if so if their values have been changed</h1>

<h1>title - name of tiddler</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasChanges</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">gatherSaveFields</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">fields</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">fetchTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">))</span> <span class="p">{</span>
		    <span class="kd">var</span> <span class="nx">n</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="nx">n</span> <span class="k">in</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">n</span><span class="p">])</span> <span class="c1">//# tiddler changed</span>
					<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">isShadowTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getShadowTiddlerText</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="o">==</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//# not checking for title or tags</span>
				<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//# changed shadow or new tiddler</span>
				<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h1>Save any open edit fields of a tiddler and updates the display as necessary</h1>

<h1>title - name of tiddler</h1>

<h1>minorUpdate - true if the modified date shouldn't be updated</h1>

<h1>returns: title of saved tiddler, or null if not saved</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">saveTiddler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">minorUpdate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tiddlerElem</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">gatherSaveFields</span><span class="p">(</span><span class="nx">tiddlerElem</span><span class="p">,</span><span class="nx">fields</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">newTitle</span> <span class="o">=</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="nx">title</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">store</span><span class="p">.</span><span class="nx">tiddlerExists</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">))</span> <span class="p">{</span>
			<span class="nx">newTitle</span> <span class="o">=</span> <span class="nx">newTitle</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
			<span class="kd">var</span> <span class="nx">creator</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">txtUserName</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">tiddlerExists</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">newTitle</span> <span class="o">!=</span> <span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">confirm</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">overwriteWarning</span><span class="p">.</span><span class="nx">format</span><span class="p">([</span><span class="nx">newTitle</span><span class="p">.</span><span class="nx">toString</span><span class="p">()])))</span>
				<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
				<span class="nx">title</span> <span class="o">=</span> <span class="nx">newTitle</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">newTitle</span> <span class="o">!=</span> <span class="nx">title</span><span class="p">)</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">closeTiddler</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tiddlerId</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">);</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;tiddler&quot;</span><span class="p">,</span><span class="nx">newTitle</span><span class="p">);</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">,</span><span class="nx">DEFAULT_VIEW_TEMPLATE</span><span class="p">);</span>
		<span class="nx">tiddlerElem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;dirty&quot;</span><span class="p">,</span><span class="s2">&quot;false&quot;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">chkForceMinorUpdate</span><span class="p">)</span>
			<span class="nx">minorUpdate</span> <span class="o">=</span> <span class="o">!</span><span class="nx">minorUpdate</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">store</span><span class="p">.</span><span class="nx">tiddlerExists</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">))</span>
			<span class="nx">minorUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">newDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">tiddlerExists</span><span class="p">(</span><span class="nx">title</span><span class="p">))</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">fetchTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">extendedFields</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
			<span class="nx">creator</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">creator</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">extendedFields</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">({},</span><span class="nx">config</span><span class="p">.</span><span class="nx">defaultCustomFields</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">n</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="nx">n</span> <span class="k">in</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">TiddlyWiki</span><span class="p">.</span><span class="nx">isStandardField</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>
				<span class="nx">extendedFields</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">tiddler</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">saveTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">newTitle</span><span class="p">,</span><span class="nx">fields</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span><span class="nx">minorUpdate</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">txtUserName</span><span class="p">,</span><span class="nx">minorUpdate</span> <span class="o">?</span> <span class="kc">undefined</span> <span class="o">:</span> <span class="nx">newDate</span><span class="p">,</span><span class="nx">fields</span><span class="p">.</span><span class="nx">tags</span><span class="p">,</span><span class="nx">extendedFields</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">creator</span><span class="p">);</span>
		<span class="nx">autoSaveChanges</span><span class="p">(</span><span class="kc">null</span><span class="p">,[</span><span class="nx">tiddler</span><span class="p">]);</span>
		<span class="k">return</span> <span class="nx">newTitle</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">permaView</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kd">var</span> <span class="nx">links</span> <span class="o">=</span> <span class="p">[];</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">forEachTiddler</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">links</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">encodeTiddlyLink</span><span class="p">(</span><span class="nx">title</span><span class="p">));</span>
	<span class="p">});</span>
	<span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">links</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">t</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
		<span class="nx">t</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">!=</span> <span class="nx">t</span><span class="p">)</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">Story</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">switchTheme</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">theme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">safeMode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="kd">var</span> <span class="nx">isAvailable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">title</span> <span class="o">?</span> <span class="nx">title</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">textPrimitives</span><span class="p">.</span><span class="nx">sectionSeparator</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span>
			<span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">tiddlerExists</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="o">||</span> <span class="nx">store</span><span class="p">.</span><span class="nx">isShadowTiddler</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="kd">var</span> <span class="nx">getSlice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">theme</span><span class="p">,</span><span class="nx">slice</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">r</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">readOnly</span><span class="p">)</span>
			<span class="nx">r</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getTiddlerSlice</span><span class="p">(</span><span class="nx">theme</span><span class="p">,</span><span class="nx">slice</span><span class="o">+</span><span class="s2">&quot;ReadOnly&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getTiddlerSlice</span><span class="p">(</span><span class="nx">theme</span><span class="p">,</span><span class="s2">&quot;Web&quot;</span><span class="o">+</span><span class="nx">slice</span><span class="p">);</span>
		<span class="nx">r</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">||</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getTiddlerSlice</span><span class="p">(</span><span class="nx">theme</span><span class="p">,</span><span class="nx">slice</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">textPrimitives</span><span class="p">.</span><span class="nx">sectionSeparator</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
			<span class="nx">r</span> <span class="o">=</span> <span class="nx">theme</span> <span class="o">+</span> <span class="nx">r</span><span class="p">;</span>
		<span class="k">return</span> <span class="nx">isAvailable</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">?</span> <span class="nx">r</span> <span class="o">:</span> <span class="nx">slice</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="kd">var</span> <span class="nx">replaceNotification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">name</span><span class="p">,</span><span class="nx">theme</span><span class="p">,</span><span class="nx">slice</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">newName</span> <span class="o">=</span> <span class="nx">getSlice</span><span class="p">(</span><span class="nx">theme</span><span class="p">,</span><span class="nx">slice</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="o">!=</span><span class="nx">newName</span> <span class="o">&amp;&amp;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">namedNotifications</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="o">==</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">store</span><span class="p">.</span><span class="nx">namedNotifications</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">newName</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">newName</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="kd">var</span> <span class="nx">pt</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">pageTemplate</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">vi</span> <span class="o">=</span> <span class="nx">DEFAULT_VIEW_TEMPLATE</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">vt</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tiddlerTemplates</span><span class="p">[</span><span class="nx">vi</span><span class="p">];</span>
	<span class="kd">var</span> <span class="nx">ei</span> <span class="o">=</span> <span class="nx">DEFAULT_EDIT_TEMPLATE</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">et</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tiddlerTemplates</span><span class="p">[</span><span class="nx">ei</span><span class="p">];</span>

	<span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">config</span><span class="p">.</span><span class="nx">notifyTiddlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">notifyTiddlers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="s2">&quot;PageTemplate&quot;</span><span class="o">:</span>
			<span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">pageTemplate</span> <span class="o">=</span> <span class="nx">replaceNotification</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">pageTemplate</span><span class="p">,</span><span class="nx">theme</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="s2">&quot;StyleSheet&quot;</span><span class="o">:</span>
			<span class="nx">removeStyleSheet</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">);</span>
			<span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">styleSheet</span> <span class="o">=</span> <span class="nx">replaceNotification</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">,</span><span class="nx">theme</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="s2">&quot;ColorPalette&quot;</span><span class="o">:</span>
			<span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">colorPalette</span> <span class="o">=</span> <span class="nx">replaceNotification</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">colorPalette</span><span class="p">,</span><span class="nx">theme</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">config</span><span class="p">.</span><span class="nx">tiddlerTemplates</span><span class="p">[</span><span class="nx">vi</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getSlice</span><span class="p">(</span><span class="nx">theme</span><span class="p">,</span><span class="s2">&quot;ViewTemplate&quot;</span><span class="p">);</span>
	<span class="nx">config</span><span class="p">.</span><span class="nx">tiddlerTemplates</span><span class="p">[</span><span class="nx">ei</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getSlice</span><span class="p">(</span><span class="nx">theme</span><span class="p">,</span><span class="s2">&quot;EditTemplate&quot;</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">startingUp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">pageTemplate</span><span class="o">!=</span><span class="nx">pt</span> <span class="o">||</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tiddlerTemplates</span><span class="p">[</span><span class="nx">vi</span><span class="p">]</span><span class="o">!=</span><span class="nx">vt</span> <span class="o">||</span> <span class="nx">config</span><span class="p">.</span><span class="nx">tiddlerTemplates</span><span class="p">[</span><span class="nx">ei</span><span class="p">]</span><span class="o">!=</span><span class="nx">et</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">refreshAll</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">refreshAllTiddlers</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">setStylesheet</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getRecursiveTiddlerText</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">refresherData</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="nx">config</span><span class="p">.</span><span class="nx">refreshers</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nx">config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">txtTheme</span> <span class="o">=</span> <span class="nx">theme</span><span class="p">;</span>
		<span class="nx">saveOption</span><span class="p">(</span><span class="s2">&quot;txtTheme&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 